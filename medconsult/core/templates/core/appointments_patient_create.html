{% extends "core/base.html" %}
{% load tz %}

{% block content %}
<h2>Request an Appointment</h2>
<p>Select a doctor, choose a date, then pick one or more 30-minute slots.</p>

{# Step 1: doctor + date selection (GET) #}
<form method="get" style="margin-top:1rem; margin-bottom:1.5rem;">
    <div class="field">
        <label for="id_doctor">Doctor</label>
        <select name="doctor_id" id="id_doctor" required>
            <option value="">-- Select a doctor --</option>
            {% for d in doctors %}
                {% with prof=d.doctor_profile %}
                    <option value="{{ d.id }}"
                        {% if selected_doctor and d.id == selected_doctor.id %}selected{% endif %}>
                        {% if prof %}
                            {{ prof.full_name }}
                            {% if prof.specialization %}
                                ({{ prof.specialization }})
                            {% endif %}
                        {% else %}
                            {{ d.email }}
                        {% endif %}
                    </option>
                {% endwith %}
            {% endfor %}
        </select>
    </div>

    <div class="field">
        <label for="id_date">Date</label>
        <input type="date"
               id="id_date"
               name="date"
               value="{% if selected_date %}{{ selected_date|date:'Y-m-d' }}{% endif %}"
               required>
    </div>

    <button type="submit" class="button button-primary">
        Show Available Slots
    </button>
</form>


{% if selected_doctor and selected_date %}
    <h3>
        Available slots for
        {% with prof=selected_doctor.doctor_profile %}
            {% if prof %}
                {{ prof.full_name }}
            {% else %}
                {{ selected_doctor.email }}
            {% endif %}
        {% endwith %}
        on {{ selected_date|date:"m/d/Y" }}
    </h3>

    {% if available_slots %}
        <p style="font-size:0.9rem; color:#4b5563; margin-top:0.25rem;">
            You can select <strong>one or more</strong> 30-minute slots.
        </p>

        <form method="post" style="margin-top:1rem;">
            {% csrf_token %}
            <input type="hidden" name="doctor_id" value="{{ selected_doctor.id }}">
            <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">

            <div class="field">
                <label>Select time slots</label>

                <div class="slot-grid">
                    {% for start, end in available_slots %}
                        <label class="slot-card">
                            <input type="checkbox"
                                   name="slot_start"
                                   value="{{ start|utc|date:'Y-m-d\\TH:i' }}">
                            <span>
                                {{ start|localtime|date:"g:i A" }} â€“
                                {{ end|localtime|date:"g:i A" }}
                            </span>
                        </label>
                    {% endfor %}
                </div>

                <small style="font-size:0.8rem; color:#6b7280;">
                    Minimum: 1 slot. You may choose multiple consecutive slots for longer sessions.
                </small>
            </div>

            <div class="field">
                <label for="id_reason">Reason / Notes (optional)</label>
                <textarea id="id_reason" name="reason" rows="3"></textarea>
            </div>

            <button type="submit" class="button button-primary">
                Confirm Appointment
            </button>
        </form>

    {% else %}
        <p style="margin-top:1rem;">
            No available 30-minute slots for this doctor on this date.
        </p>
    {% endif %}
{% endif %}

{% endblock %}
