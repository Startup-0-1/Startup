{% extends "ui/layout_app.html" %}
{% load tz %}

{% block title %}My Schedule — MedConsult{% endblock %}

{% block content %}
<div class="space-y-8">
  <div>
    <h1 class="text-2xl font-semibold tracking-tight">My Schedule</h1>
    <p class="text-sm text-slate-600 mt-1">
      Set your availability. Patients can book 30-minute slots within these windows.
      <span class="text-slate-500">(Times shown in your account timezone.)</span>
    </p>
  </div>

  <!-- 1) Pick a date to inspect existing 30-min slots -->
  <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-semibold">View slots for a date</h2>

    <form method="get" class="mt-4 grid md:grid-cols-3 gap-4 items-end">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
        <input type="date" name="date"
               value="{% if selected_date %}{{ selected_date|date:'Y-m-d' }}{% endif %}"
               class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
      </div>

      <button type="submit"
        class="rounded-xl border border-slate-200 bg-white px-5 py-2 text-sm font-medium hover:bg-slate-50 transition">
        View Slots
      </button>
    </form>
  </div>

  <!-- 2) Create / update availability window for a date -->
  <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6">
    <h2 class="text-lg font-semibold">Create availability window</h2>
    <p class="text-sm text-slate-600 mt-1">This generates 30-minute slots within the time range.</p>

    <form method="post" class="mt-4 grid md:grid-cols-4 gap-4 items-end">
      {% csrf_token %}
      <input type="hidden" name="action" value="save_window">

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
        <input type="date" name="date"
               value="{% if selected_date %}{{ selected_date|date:'Y-m-d' }}{% endif %}"
               required
               class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Open</label>
        <input type="time" name="start_time" required
               class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
      </div>

      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Close</label>
        <input type="time" name="end_time" required
               class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-slate-300">
      </div>

      <button type="submit"
        class="rounded-xl bg-slate-900 text-white px-5 py-2 text-sm font-medium hover:bg-slate-800 transition">
        Save Availability
      </button>
    </form>
  </div>

  <!-- 3) For selected date: show free slots -->
  {% if selected_date %}
    <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6 space-y-4">
      <div>
        <h2 class="text-lg font-semibold">30-minute slots on {{ selected_date|date:"m/d/Y" }}</h2>
        <p class="text-sm text-slate-600 mt-1">Only future free slots are shown.</p>
      </div>

      {% if available_slots %}
        <div class="overflow-x-auto rounded-2xl border border-slate-200">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 text-slate-600">
              <tr>
                <th class="text-left font-medium px-4 py-3">Slot</th>
                <th class="text-left font-medium px-4 py-3">Actions</th>
              </tr>
            </thead>

            <tbody class="divide-y divide-slate-200">
              {% for start_dt, end_dt in available_slots %}
                <tr class="hover:bg-slate-50">
                  <td class="px-4 py-3">
                    {{ start_dt|localtime|date:"g:i A" }} – {{ end_dt|localtime|date:"g:i A" }}
                  </td>

                  <td class="px-4 py-3">
                    <form method="post" class="inline">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="delete_slot">
                      <input type="hidden" name="selected_date" value="{{ selected_date|date:'Y-m-d' }}">
                      <input type="hidden" name="slot_start" value="{{ start_dt|localtime|date:'Y-m-d\\TH:i' }}">
                      <button type="submit"
                        class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50 transition">
                        Delete Slot
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
          No future free 30-minute slots for this date.
        </div>
      {% endif %}
    </div>
  {% endif %}

  <!-- 4) All availability windows -->
  <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-6 space-y-4">
    <div>
      <h2 class="text-lg font-semibold">All Availability Windows</h2>
      <p class="text-sm text-slate-600 mt-1">Your saved windows, across all dates.</p>
    </div>

    {% if windows %}
      <div class="overflow-x-auto rounded-2xl border border-slate-200">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="text-left font-medium px-4 py-3">Date</th>
              <th class="text-left font-medium px-4 py-3">Open</th>
              <th class="text-left font-medium px-4 py-3">Close</th>
            </tr>
          </thead>

          <tbody class="divide-y divide-slate-200">
            {% for w in windows %}
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-3">{{ w.date|date:"m/d/Y" }}</td>
                <td class="px-4 py-3">{{ w.start_time|time:"g:i A" }}</td>
                <td class="px-4 py-3">{{ w.end_time|time:"g:i A" }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
        No availability set yet.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
