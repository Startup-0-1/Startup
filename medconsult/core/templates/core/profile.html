{% extends "core/base.html" %}
{% load tz %}

{% block content %}
<h2>Profile</h2>
<p>View and update your account details.</p>

<!-- ===================================================== -->
<!-- BASIC PROFILE INFORMATION -->
<!-- ===================================================== -->
<h3>Basic Information</h3>

<form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="update_profile">

    <div class="field">
        <label>Email</label>
        <input type="email" name="email" value="{{ user_obj.email }}" required>
    </div>

    {% if patient_profile %}
        <div class="field">
            <label>Full Name</label>
            <input type="text" name="full_name" value="{{ patient_profile.full_name }}">
        </div>

        <div class="field">
            <label>Date of Birth (MM/DD/YYYY)</label>
            <input type="text" id="dob_input" name="date_of_birth"
                   value="{{ patient_profile.date_of_birth }}"
                   placeholder="MM/DD/YYYY">
            <small style="font-size:0.8rem; color:#6b7280;">
                You may type 06271992 and it will auto-format.
            </small>
        </div>

        <div class="field">
            <label>Gender</label>
            <input type="text" name="gender" value="{{ patient_profile.gender }}">
        </div>

        <div class="field">
            <label>Contact Number</label>
            <input type="text" name="contact_number" value="{{ patient_profile.contact_number }}">
        </div>

        <div class="field">
            <label>Address</label>
            <textarea name="address" rows="2">{{ patient_profile.address }}</textarea>
        </div>

        <div class="field">
            <label>Emergency Contact</label>
            <input type="text" name="emergency_contact" value="{{ patient_profile.emergency_contact }}">
        </div>

        <div class="field">
            <label>Insurance Provider</label>
            <input type="text" name="insurance_provider" value="{{ patient_profile.insurance_provider }}">
        </div>

        <div class="field">
            <label>Insurance Policy Number</label>
            <input type="text" name="insurance_policy_number"
                   value="{{ patient_profile.insurance_policy_number }}">
        </div>
    {% endif %}

    {% if doctor_profile %}
        <div class="field">
            <label>Full Name</label>
            <input type="text" name="full_name" value="{{ doctor_profile.full_name }}">
        </div>

        <div class="field">
            <label>Specialization</label>
            <input type="text" name="specialization" value="{{ doctor_profile.specialization }}">
        </div>

        <div class="field">
            <label>Contact Number</label>
            <input type="text" name="contact_number" value="{{ doctor_profile.contact_number }}">
        </div>

        <div class="field">
            <label>Clinic Name</label>
            <input type="text" name="clinic_name" value="{{ doctor_profile.clinic_name }}">
        </div>

        <div class="field">
            <label>Clinic Address</label>
            <textarea name="clinic_address" rows="2">{{ doctor_profile.clinic_address }}</textarea>
        </div>
    {% endif %}

    <!-- ===================================================== -->
    <!-- TIMEZONE SELECTION -->
    <!-- ===================================================== -->
    <div class="field">
        <label>Your Timezone</label>
        <select name="timezone" required>
            {% for tz in timezones %}
                <option value="{{ tz }}" {% if tz == user_obj.timezone %}selected{% endif %}>
                    {{ tz }}
                </option>
            {% endfor %}
        </select>
        <small style="font-size:0.8rem; color:#6b7280;">
            Used to show appointments in your local time.
        </small>
    </div>

    <button type="submit" class="button button-primary">Save Profile</button>
</form>

<hr style="margin:1.5rem 0;">


<!-- ===================================================== -->
<!-- CHANGE PASSWORD -->
<!-- ===================================================== -->
<h3>Change Password</h3>

<form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="change_password">

    <div class="field">
        <label>Current Password</label>
        <input type="password" name="current_password" required>
    </div>

    <div class="field">
        <label>New Password</label>
        <input type="password" name="new_password1" required>
    </div>

    <div class="field">
        <label>Confirm New Password</label>
        <input type="password" name="new_password2" required>
    </div>

    <button type="submit" class="button button-outline">
        Update Password
    </button>
</form>

<hr style="margin:1.5rem 0;">


<!-- ===================================================== -->
<!-- PROFILE IMAGE -->
<!-- ===================================================== -->
<h3>Profile Image</h3>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="action" value="upload_image">

    <div class="field">
        <label>Upload Image (JPG / PNG)</label>
        <input type="file" name="profile_image" accept="image/jpeg,image/png">
    </div>

    <button type="submit" class="button button-outline">Upload Image</button>
</form>

{% if user_obj.profile_image %}
    <p style="margin-top:1rem;">Current image:</p>
    <img src="{{ user_obj.profile_image.url }}"
         alt="Profile image"
         style="width:80px;height:80px;border-radius:999px;object-fit:cover;">
{% endif %}

<!-- ===================================================== -->
<!-- DOB AUTO-FORMAT SCRIPT -->
<!-- ===================================================== -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const dobInput = document.getElementById("dob_input");
    if (!dobInput) return;

    dobInput.addEventListener("blur", function () {
        let v = dobInput.value.trim();
        if (!v) return;

        const digits = v.replace(/\D/g, '');
        if (digits.length === 8) {
            const mm = digits.slice(0,2);
            const dd = digits.slice(2,4);
            const yyyy = digits.slice(4);

            if (parseInt(mm) >= 1 && parseInt(mm) <= 12 &&
                parseInt(dd) >= 1 && parseInt(dd) <= 31) {
                dobInput.value = `${mm}/${dd}/${yyyy}`;
            }
        }
    });
});
</script>

{% endblock %}
