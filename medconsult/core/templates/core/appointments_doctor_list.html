{% extends "ui/layout_app.html" %}
{% load tz %}

{% block title %}My Patients & Appointments — MedConsult{% endblock %}

{% block content %}
<div class="space-y-6">
  <div>
    <h1 class="text-2xl font-semibold tracking-tight">My Patients & Appointments</h1>
    <p class="text-sm text-slate-600 mt-1">Review, approve, reject, complete, or cancel appointments.</p>
  </div>

  {% if appointment_blocks %}
    <div class="overflow-x-auto rounded-2xl bg-white border border-slate-200 shadow-sm">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left font-medium px-4 py-3">Date</th>
            <th class="text-left font-medium px-4 py-3">Time</th>
            <th class="text-left font-medium px-4 py-3">Patient</th>
            <th class="text-left font-medium px-4 py-3">Status</th>
            <th class="text-left font-medium px-4 py-3">Paid?</th>
            <th class="text-left font-medium px-4 py-3">Reason</th>
            <th class="text-left font-medium px-4 py-3">Actions</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-slate-200">
          {% for block in appointment_blocks %}
            <tr class="align-top hover:bg-slate-50">
              <td class="px-4 py-3 whitespace-nowrap">
                {{ block.start|localtime|date:"M j, Y" }}
              </td>

              <td class="px-4 py-3 whitespace-nowrap">
                {{ block.start|localtime|time:"g:i a" }} – {{ block.end|localtime|time:"g:i a" }}
              </td>

              <td class="px-4 py-3">
                {% if block.patient.patient_profile %}
                  <div class="font-medium text-slate-900">{{ block.patient.patient_profile.full_name }}</div>
                {% else %}
                  <div class="font-medium text-slate-900">{{ block.patient.get_display_name }}</div>
                {% endif %}
                <div class="text-xs text-slate-500">{{ block.patient.email }}</div>
              </td>

              <td class="px-4 py-3">
                <div class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium
                  {% if block.status == 'completed' %} bg-emerald-50 text-emerald-800 border border-emerald-200
                  {% elif block.status == 'cancelled' %} bg-rose-50 text-rose-800 border border-rose-200
                  {% elif block.status == 'approved' %} bg-sky-50 text-sky-800 border border-sky-200
                  {% elif block.status == 'rejected' %} bg-amber-50 text-amber-800 border border-amber-200
                  {% else %} bg-slate-50 text-slate-800 border border-slate-200 {% endif %}">
                  {{ block.status|title }}
                </div>

                {% if block.rescheduled_from %}
                  <div class="text-xs text-slate-500 mt-1">
                    Rescheduled from {{ block.rescheduled_from.scheduled_for|localtime|date:"M j, Y g:i a" }}
                  </div>
                {% endif %}
              </td>

              <td class="px-4 py-3">
                {% if block.payment and block.payment.status == "paid" %}
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-emerald-50 text-emerald-800 border border-emerald-200">
                    Yes
                  </span>
                {% else %}
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-slate-50 text-slate-800 border border-slate-200">
                    No
                  </span>
                {% endif %}
              </td>

              <td class="px-4 py-3">
                {{ block.reason|default:"—" }}
              </td>

              <td class="px-4 py-3 space-y-3">
                <!-- Status update form -->
                <form method="post" action="{% url 'doctor-appointments-update' %}" class="space-y-2">
                  {% csrf_token %}
                  <input type="hidden" name="mode" value="set_status">
                  {% for sid in block.slot_ids %}
                    <input type="hidden" name="slot_ids" value="{{ sid }}">
                  {% endfor %}

                  <div class="flex flex-wrap gap-2">
                    <button type="submit" name="new_status" value="approved"
                      class="rounded-xl bg-slate-900 text-white px-3 py-2 text-xs font-medium hover:bg-slate-800 transition">
                      Approve
                    </button>

                    <button type="submit" name="new_status" value="rejected"
                      class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-medium hover:bg-slate-50 transition">
                      Reject
                    </button>

                    <button type="submit" name="new_status" value="completed"
                      class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-medium hover:bg-slate-50 transition">
                      Mark Completed
                    </button>

                    <button type="submit" name="new_status" value="cancelled"
                      class="rounded-xl border border-rose-200 bg-rose-50 text-rose-900 px-3 py-2 text-xs font-medium hover:bg-rose-100 transition">
                      Cancel
                    </button>
                  </div>
                </form>

                <!-- Cancel slots form -->
                <form method="post" action="{% url 'doctor-appointments-update' %}" class="space-y-2">
                  {% csrf_token %}
                  <input type="hidden" name="mode" value="cancel_slots">

                  <div class="max-h-40 overflow-auto rounded-xl border border-slate-200 bg-white p-3 space-y-2">
                    {% for sr in block.slot_ranges %}
                      <label class="flex items-start gap-2 text-xs text-slate-700">
                        <input type="checkbox" name="slot_ids" value="{{ sr.id }}" class="mt-1">
                        <span>
                          {{ sr.start|localtime|time:"g:i a" }} – {{ sr.end|localtime|time:"g:i a" }}
                        </span>
                      </label>
                    {% endfor %}
                  </div>

                  <button type="submit"
                    class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs font-medium hover:bg-slate-50 transition">
                    Cancel selected slots
                  </button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-8 text-center">
      <h3 class="text-lg font-semibold">No appointments yet</h3>
      <p class="text-sm text-slate-600 mt-2">When patients book, they’ll appear here.</p>
    </div>
  {% endif %}
</div>
{% endblock %}
