{% extends "core/base.html" %}
{% load tz %}

{% block content %}
<h2>My Patients & Appointments</h2>

<table style="width:100%; border-collapse:collapse; margin-top:1rem;">
    <thead>
        <tr style="background:#f3f4f6;">
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #e5e7eb;">Date</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #e5e7eb;">Time</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #e5e7eb;">Patient</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #e5e7eb;">Status</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #e5e7eb;">Paid?</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #e5e7eb;">Reason</th>
            <th style="text-align:left; padding:0.5rem; border-bottom:1px solid #e5e7eb;">Actions</th>
        </tr>
    </thead>
    <tbody>
        {% if appointment_blocks %}
            {% for block in appointment_blocks %}
                <tr valign="top">
                    <td style="padding:0.5rem; border-bottom:1px solid #e5e7eb;">
                        {{ block.start|localtime|date:"M j, Y" }}
                    </td>

                    <td style="padding:0.5rem; border-bottom:1px solid #e5e7eb;">
                        {{ block.start|localtime|time:"g:i a" }} – {{ block.end|localtime|time:"g:i a" }}
                    </td>

                    <td style="padding:0.5rem; border-bottom:1px solid #e5e7eb;">
                        {% if block.patient.patient_profile %}
                            {{ block.patient.patient_profile.full_name }}
                        {% else %}
                            {{ block.patient.get_display_name }}
                        {% endif %}
                    </td>

                    <td style="padding:0.5rem; border-bottom:1px solid #e5e7eb;">
                        {{ block.status|title }}
                        {% if block.rescheduled_from %}
                            <div style="font-size:0.8rem; color:#6b7280;">
                                (Rescheduled from {{ block.rescheduled_from.scheduled_for|localtime|date:"M j, Y g:i a" }})
                            </div>
                        {% endif %}
                    </td>

                    <td style="padding:0.5rem; border-bottom:1px solid #e5e7eb;">
                        {% if block.payment and block.payment.status == "paid" %}
                            Yes
                        {% else %}
                            No
                        {% endif %}
                    </td>

                    <td style="padding:0.5rem; border-bottom:1px solid #e5e7eb;">
                        {{ block.reason|default:"—" }}
                    </td>

                    <td style="padding:0.5rem; border-bottom:1px solid #e5e7eb;">

                        {# Status update form #}
                        <form method="post"
                              action="{% url 'doctor-appointments-update' %}"
                              style="margin-bottom:0.5rem;">
                            {% csrf_token %}
                            <input type="hidden" name="mode" value="set_status">
                            {% for sid in block.slot_ids %}
                                <input type="hidden" name="slot_ids" value="{{ sid }}">
                            {% endfor %}

                            <div style="display:flex; gap:0.25rem; flex-wrap:wrap;">
                                <button type="submit" name="new_status" value="approved"
                                        class="button button-primary"
                                        style="padding:0.25rem 0.6rem; font-size:0.8rem;">
                                    Approve
                                </button>
                                <button type="submit" name="new_status" value="rejected"
                                        class="button button-outline"
                                        style="padding:0.25rem 0.6rem; font-size:0.8rem;">
                                    Reject
                                </button>
                                <button type="submit" name="new_status" value="completed"
                                        class="button button-outline"
                                        style="padding:0.25rem 0.6rem; font-size:0.8rem;">
                                    Mark Completed
                                </button>
                                <button type="submit" name="new_status" value="cancelled"
                                        class="button button-outline"
                                        style="padding:0.25rem 0.6rem; font-size:0.8rem;">
                                    Cancel
                                </button>
                            </div>
                        </form>

                        {# Cancel slots form #}
                        <form method="post"
                              action="{% url 'doctor-appointments-update' %}"
                              style="margin-top:0.5rem;">
                            {% csrf_token %}
                            <input type="hidden" name="mode" value="cancel_slots">

                            <div style="max-height:140px; overflow:auto; border:1px solid #e5e7eb;
                                        padding:0.4rem; border-radius:0.5rem; margin-bottom:0.4rem;">
                                {% for sr in block.slot_ranges %}
                                    <div>
                                        <label>
                                            <input type="checkbox" name="slot_ids" value="{{ sr.id }}">
                                            {{ sr.start|localtime|time:"g:i a" }} – {{ sr.end|localtime|time:"g:i a" }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>

                            <button type="submit" class="button button-outline"
                                    style="padding:0.25rem 0.6rem; font-size:0.8rem;">
                                Cancel selected slots
                            </button>
                        </form>

                    </td>
                </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="7" style="padding:0.75rem; text-align:center; color:#6b7280;">
                    No appointments yet.
                </td>
            </tr>
        {% endif %}
    </tbody>
</table>
{% endblock %}
