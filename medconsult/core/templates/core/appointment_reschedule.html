{% extends "core/base.html" %}
{% load tz %}

{% block content %}
<h2>Reschedule Appointment</h2>

<p style="margin-bottom:1rem;">
    Doctor:
    {% if doctor.doctor_profile %}
        {{ doctor.doctor_profile.full_name }}
    {% else %}
        {{ doctor.email }}
    {% endif %}
    <br>
    Current time:
    {{ original_start|localtime|date:"M j, Y g:i a" }} – {{ original_end|localtime|date:"g:i a" }}
</p>

<!-- ========================================================= -->
<!-- 1) DATE INPUT (MM/DD/YYYY + auto-format)                  -->
<!-- ========================================================= -->
<form method="get" action="{% url 'patient-appointment-reschedule' %}"
      style="margin-top:1rem; margin-bottom:1rem;">
    
    <input type="hidden" name="doctor_id" value="{{ doctor_id }}">
    <input type="hidden" name="start" value="{{ start_str }}">
    <input type="hidden" name="end" value="{{ end_str }}">

    <div class="field">
        <label>Select new date</label>

        <!-- MM/DD/YYYY visible field -->
        <input type="text" id="new_date_display" placeholder="MM/DD/YYYY"
               value="{% if selected_date %}{{ selected_date|date:'m/d/Y' }}{% endif %}">

        <!-- Canonical hidden YYYY-MM-DD -->
        <input type="hidden" name="new_date" id="new_date_hidden"
               value="{% if selected_date %}{{ selected_date|date:'Y-m-d' }}{% endif %}">
    </div>

    <button type="submit" class="button button-outline">Show available slots</button>
</form>

<!-- ========================================================= -->
<!-- 2) Display Slots                                          -->
<!-- ========================================================= -->
{% if selected_date %}
    <h3>Available 30-minute slots on {{ selected_date|date:"M j, Y" }}</h3>

    {% if available_slots %}
        <form method="post">
            {% csrf_token %}

            <input type="hidden" name="doctor_id" value="{{ doctor_id }}">
            <input type="hidden" name="start" value="{{ start_str }}">
            <input type="hidden" name="end" value="{{ end_str }}">

            <!-- Canonical date for POST -->
            <input type="hidden" name="new_date" value="{{ selected_date|date:'Y-m-d' }}">

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:0.75rem; margin-top:0.75rem;">
                {% for start_dt, end_dt in available_slots %}
                    <label style="border:1px solid #e5e7eb; padding:0.5rem 0.75rem; border-radius:0.5rem; cursor:pointer; display:flex; align-items:center; gap:0.4rem;">
                        <input type="radio" name="new_slot"
                               value="{{ start_dt|utc|date:'Y-m-d\\TH:i' }}">
                        <span>
                            {{ start_dt|localtime|date:"g:i A" }} – 
                            {{ end_dt|localtime|date:"g:i A" }}
                        </span>
                    </label>
                {% endfor %}
            </div>

            <button type="submit" class="button button-primary" style="margin-top:1rem;">
                Confirm Reschedule
            </button>
        </form>

    {% else %}
        <p>No available slots on this day.</p>
    {% endif %}
{% endif %}



<!-- ========================================================= -->
<!-- 3) Universal Date Auto-Formatter (MMDDYYYY → MM/DD/YYYY)  -->
<!-- ========================================================= -->
<script>
function normalizeDateInput(visibleInput, hiddenInput) {
    visibleInput.addEventListener("blur", function () {
        let raw = visibleInput.value.trim();
        if (!raw) return;

        // Strip non-digits
        let digits = raw.replace(/\D/g, "");

        if (digits.length === 8) {
            // Convert mmddyyyy → mm/dd/yyyy
            let mm = digits.slice(0, 2);
            let dd = digits.slice(2, 4);
            let yyyy = digits.slice(4);
            visibleInput.value = `${mm}/${dd}/${yyyy}`;
            hiddenInput.value = `${yyyy}-${mm}-${dd}`;
        } else {
            // Accept existing MM/DD/YYYY
            let parts = raw.split("/");
            if (parts.length === 3) {
                hiddenInput.value = `${parts[2]}-${parts[0]}-${parts[1]}`;
            }
        }
    });
}

document.addEventListener("DOMContentLoaded", function () {
    const display = document.getElementById("new_date_display");
    const hidden = document.getElementById("new_date_hidden");

    if (display && hidden) {
        normalizeDateInput(display, hidden);
    }
});
</script>
{% endblock %}