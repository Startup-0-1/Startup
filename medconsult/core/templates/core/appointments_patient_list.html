{% extends "ui/layout_app.html" %}
{% load tz %}

{% block title %}My Appointments — MedConsult{% endblock %}

{% block content %}
<div class="space-y-6">
  <div class="flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight">My Appointments</h1>
      <p class="text-sm text-slate-600 mt-1">Appointments shown in your local time.</p>
    </div>

    <a href="{% url 'doctor-search' %}"
       class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-5 py-2 text-sm font-medium hover:bg-slate-50 transition">
      Find Doctors
    </a>
  </div>

  {% if appointment_blocks %}
    <div class="overflow-x-auto rounded-2xl bg-white border border-slate-200 shadow-sm">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="text-left font-medium px-4 py-3">Date</th>
            <th class="text-left font-medium px-4 py-3">Time</th>
            <th class="text-left font-medium px-4 py-3">Doctor</th>
            <th class="text-left font-medium px-4 py-3">Status</th>
            <th class="text-left font-medium px-4 py-3">Paid?</th>
            <th class="text-left font-medium px-4 py-3">Reason</th>
            <th class="text-left font-medium px-4 py-3">Actions</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-slate-200">
          {% for block in appointment_blocks %}
            <tr class="hover:bg-slate-50">
              <!-- DATE -->
              <td class="px-4 py-3">
                {{ block.start|localtime|date:"m/d/Y" }}
              </td>

              <!-- TIME RANGE -->
              <td class="px-4 py-3">
                {{ block.start|localtime|time:"g:i a" }} –
                {{ block.end|localtime|time:"g:i a" }}
              </td>

              <!-- DOCTOR -->
              <td class="px-4 py-3">
                {% if block.doctor.doctor_profile %}
                  <div class="font-medium text-slate-900">{{ block.doctor.doctor_profile.full_name }}</div>
                {% else %}
                  <div class="font-medium text-slate-900">{{ block.doctor.get_display_name }}</div>
                {% endif %}
                <div class="text-xs text-slate-500">{{ block.doctor.email }}</div>
              </td>

              <!-- STATUS -->
              <td class="px-4 py-3">
                <div class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium
                  {% if block.status == 'completed' %} bg-emerald-50 text-emerald-800 border border-emerald-200
                  {% elif block.status == 'cancelled' %} bg-rose-50 text-rose-800 border border-rose-200
                  {% elif block.status == 'rescheduled' %} bg-amber-50 text-amber-800 border border-amber-200
                  {% else %} bg-slate-50 text-slate-800 border border-slate-200 {% endif %}">
                  {{ block.status|title }}
                </div>

                {% if block.rescheduled_from %}
                  <div class="text-xs text-slate-500 mt-1">
                    Rescheduled from {{ block.rescheduled_from.scheduled_for|localtime|date:"m/d/Y g:i a" }}
                  </div>
                {% endif %}
              </td>

              <!-- PAID -->
              <td class="px-4 py-3">
                {% if block.payment and block.payment.status == "paid" %}
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-emerald-50 text-emerald-800 border border-emerald-200">
                    Yes
                  </span>
                {% else %}
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium bg-slate-50 text-slate-800 border border-slate-200">
                    No
                  </span>
                {% endif %}
              </td>

              <!-- REASON -->
              <td class="px-4 py-3">
                {{ block.reason|default:"—" }}
              </td>

              <!-- ACTIONS -->
              <td class="px-4 py-3">
                {% if block.start > now and block.status != "cancelled" and block.status != "completed" %}
                  <a
                    href="{% url 'patient-appointment-reschedule' %}?doctor_id={{ block.doctor.id }}&start={{ block.start|date:'Y-m-d\\TH:i' }}&end={{ block.end|date:'Y-m-d\\TH:i' }}"
                    class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-medium hover:bg-slate-50 transition"
                  >
                    Reschedule
                  </a>
                {% else %}
                  <span class="text-slate-400">—</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="rounded-2xl bg-white border border-slate-200 shadow-sm p-8 text-center">
      <h3 class="text-lg font-semibold">No appointments yet</h3>
      <p class="text-sm text-slate-600 mt-2">When you book an appointment, it will show up here.</p>
      <div class="mt-4">
        <a href="{% url 'doctor-search' %}"
           class="inline-flex items-center justify-center rounded-xl bg-slate-900 text-white px-5 py-2 text-sm font-medium hover:bg-slate-800 transition">
          Find a doctor
        </a>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
